---
layout: post
title: "RIA Services Validation: ViewModel Validation with Entity Rules"
date: 2011-09-07 06:31:01 -0700
comments: true
tags: ["RiaServicesValidation", "RIAServicesValidation", "Validation", "Silverlight", "DataAnnotations"]
redirect_from: ["/archive/2011/09/06/ViewModelValidation.aspx/", "/archive/2011/09/06/viewmodelvalidation.aspx"]
author: "Jeff Handley"
---
<!-- more -->
<p>For those of you familiar with the ViewModel (or MVVM) pattern, you are likely also familiar with a typical pain point regarding validation: you often need to duplicate your entity validation metadata onto your ViewModel classes.  This can lead to burdensome dual maintenance of your validation rules, and it can seem very frustrating that with the server to client metadata propagation that RIA Services offers, your ViewModel classes are left dangling out there for you to manage yourself.  In this post, I’ll illustrate a utility I created that allows a ViewModel to assume validation metadata from model classes or properties, eliminating the dual maintenance.</p>  <h3>ModelPropertyValidator</h3>  <p>Virtually every ViewModel will have properties that actually represent properties from your model.  Let’s use the meeting invitation model from earlier RIA Services Validation posts as an example.  My meeting object has a bunch of properties such as Title, Start, End, Location, MinimumAttendees, MaximumAttendees, and Details.  It’s easy to imagine a ViewModel that could be used for managing meetings where the UI would have a subset or superset of the meeting properties.  For each field on the screen that represents a meeting property, I should be able to indicate which model property is associated with each ViewModel property so that the model validation can be imported automatically.  This is where ModelPropertyValidator comes in.</p>  <p>Here’s a subset of the Meeting class with its data annotations in my Web project:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:659c81d7-43aa-4cca-9634-9279487f2263" class="wlWriterSmartContent">   <div style="border-bottom: #000080 1px solid; border-left: #000080 1px solid; font-family: 'Courier New', courier, monospace; color: #000; font-size: 10pt; border-top: #000080 1px solid; border-right: #000080 1px solid">     <div style="padding-bottom: 2px; padding-left: 5px; padding-right: 5px; font-family: verdana, tahoma, arial, sans-serif; background: #000080; color: #fff; font-weight: bold; padding-top: 2px">Code Snippet</div>      <div style="background: #ddd; max-height: 300px; overflow: auto">       <ol style="padding-bottom: 0px; margin: 0px 0px 0px 2.5em; padding-left: 5px; padding-right: 0px; background: #ffffff; padding-top: 0px">         <li>[<span style="color: #2b91af">CustomValidation</span>(<span style="color: #0000ff">typeof</span>(<span style="color: #2b91af">MeetingValidators</span>), <span style="color: #a31515">"PreventExpensiveMeetings"</span>)] </li>          <li style="background: #f3f3f3">[<span style="color: #2b91af">CustomValidation</span>(<span style="color: #0000ff">typeof</span>(<span style="color: #2b91af">MeetingValidators</span>), <span style="color: #a31515">"PreventDoubleBooking"</span>)] </li>          <li>[<span style="color: #2b91af">MetadataType</span>(<span style="color: #0000ff">typeof</span>(<span style="color: #2b91af">Meeting</span>.<span style="color: #2b91af">MeetingMetadata</span>))] </li>          <li style="background: #f3f3f3"><span style="color: #0000ff">public</span> <span style="color: #0000ff">partial</span> <span style="color: #0000ff">class</span> <span style="color: #2b91af">Meeting</span> </li>          <li>{ </li>          <li style="background: #f3f3f3">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> <span style="color: #2b91af">MeetingMetadata</span> </li>          <li>    { </li>          <li style="background: #f3f3f3">        [<span style="color: #2b91af">Key</span>] </li>          <li>        [<span style="color: #2b91af">Display</span>(AutoGenerateField = <span style="color: #0000ff">false</span>)] </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> MeetingId { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; } </li>          <li>  </li>          <li style="background: #f3f3f3">        [<span style="color: #2b91af">Required</span>] </li>          <li>        [<span style="color: #2b91af">CustomValidation</span>(<span style="color: #0000ff">typeof</span>(<span style="color: #2b91af">MeetingValidators</span>), <span style="color: #a31515">"NoEarlyMeetings"</span>)] </li>          <li style="background: #f3f3f3">        [<span style="color: #2b91af">CompareValidator</span>(<span style="color: #2b91af">CompareOperator</span>.LessThan, <span style="color: #a31515">"End"</span>, </li>          <li>            ErrorMessage = <span style="color: #a31515">"Meetings cannot result in time travel."</span>)] </li>          <li style="background: #f3f3f3">        [<span style="color: #2b91af">DateValidator</span>(<span style="color: #2b91af">DateValidatorType</span>.Future)] </li>          <li>        [<span style="color: #2b91af">Display</span>(Order = 1)] </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">public</span> <span style="color: #2b91af">DateTime</span> Start { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; } </li>          <li>  </li>          <li style="background: #f3f3f3">        [<span style="color: #2b91af">Required</span>] </li>          <li>        [<span style="color: #2b91af">CompareValidator</span>(<span style="color: #2b91af">CompareOperator</span>.GreaterThan, <span style="color: #a31515">"Start"</span>, </li>          <li style="background: #f3f3f3">            ErrorMessage = <span style="color: #a31515">"Meetings cannot result in time travel."</span>)] </li>          <li>        [<span style="color: #2b91af">Display</span>(Order = 2)] </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">public</span> <span style="color: #2b91af">DateTime</span> End { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; } </li>          <li>  </li>          <li style="background: #f3f3f3">        [<span style="color: #2b91af">Required</span>] </li>          <li>        [<span style="color: #2b91af">StringLength</span>(80, MinimumLength = 5, </li>          <li style="background: #f3f3f3">            ErrorMessageResourceType = <span style="color: #0000ff">typeof</span>(<span style="color: #2b91af">ValidationErrorResources</span>), </li>          <li>            ErrorMessageResourceName = <span style="color: #a31515">"TitleStringLengthErrorMessage"</span>)] </li>          <li style="background: #f3f3f3">        <span style="color: #008000">// {0} must be at least {2} characters and no more than {1}.</span> </li>          <li>        [<span style="color: #2b91af">Display</span>(Order = 0)] </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Title { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; } </li>       </ol>     </div>   </div> </div>  <p> </p>  <p>When a ViewModel is going to expose the Start property for a meeting, it would be a nightmare to have to keep all of the validation attributes in sync.  To alleviate this, I created an attribute called ModelPropertyValidatorAttribute that acts as a proxy from a ViewModel property to a Model property.  Here’s what it looks like to use it:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:94bcf9a7-a2a1-4503-84cd-8b04b8958344" class="wlWriterSmartContent">   <div style="border-bottom: #000080 1px solid; border-left: #000080 1px solid; font-family: 'Courier New', courier, monospace; color: #000; font-size: 10pt; border-top: #000080 1px solid; border-right: #000080 1px solid">     <div style="padding-bottom: 2px; padding-left: 5px; padding-right: 5px; font-family: verdana, tahoma, arial, sans-serif; background: #000080; color: #fff; font-weight: bold; padding-top: 2px">Code Snippet</div>      <div style="background: #ddd; max-height: 300px; overflow: auto">       <ol style="padding-bottom: 0px; margin: 0px 0px 0px 2.5em; padding-left: 5px; padding-right: 0px; background: #ffffff; padding-top: 0px">         <li><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> <span style="color: #2b91af">MeetingEntryViewModel</span> : <span style="color: #2b91af">ViewModelBase</span> </li>          <li style="background: #f3f3f3">{ </li>          <li>    <span style="color: #0000ff">private</span> <span style="color: #2b91af">DateTime</span> start; </li>          <li style="background: #f3f3f3">    <span style="color: #0000ff">private</span> <span style="color: #2b91af">DateTime</span> end; </li>          <li>  </li>          <li style="background: #f3f3f3">    [<span style="color: #2b91af">ModelPropertyValidator</span>(<span style="color: #0000ff">typeof</span>(<span style="color: #2b91af">Meeting</span>))] </li>          <li>    <span style="color: #0000ff">public</span> <span style="color: #2b91af">DateTime</span> Start </li>          <li style="background: #f3f3f3">    { </li>          <li>        <span style="color: #0000ff">get</span> { <span style="color: #0000ff">return</span> <span style="color: #0000ff">this</span>.start; } </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">set</span> </li>          <li>        { </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">if</span> (<span style="color: #0000ff">this</span>.start != <span style="color: #0000ff">value</span>) </li>          <li>            { </li>          <li style="background: #f3f3f3">                <span style="color: #0000ff">this</span>.ValidateProperty(<span style="color: #a31515">"Start"</span>, <span style="color: #0000ff">value</span>); </li>          <li>                <span style="color: #0000ff">this</span>.start = <span style="color: #0000ff">value</span>; </li>          <li style="background: #f3f3f3">                <span style="color: #0000ff">this</span>.RaisePropertyChanged(<span style="color: #a31515">"Start"</span>); </li>          <li>            } </li>          <li style="background: #f3f3f3">        } </li>          <li>    } </li>          <li style="background: #f3f3f3">  </li>          <li>    [<span style="color: #2b91af">ModelPropertyValidator</span>(<span style="color: #0000ff">typeof</span>(<span style="color: #2b91af">Meeting</span>))] </li>          <li style="background: #f3f3f3">    <span style="color: #0000ff">public</span> <span style="color: #2b91af">DateTime</span> End </li>          <li>    { </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">get</span> { <span style="color: #0000ff">return</span> <span style="color: #0000ff">this</span>.end; } </li>          <li>        <span style="color: #0000ff">set</span> </li>          <li style="background: #f3f3f3">        { </li>          <li>            <span style="color: #0000ff">if</span> (<span style="color: #0000ff">this</span>.end != <span style="color: #0000ff">value</span>) </li>          <li style="background: #f3f3f3">            { </li>          <li>                <span style="color: #0000ff">this</span>.ValidateProperty(<span style="color: #a31515">"End"</span>, <span style="color: #0000ff">value</span>); </li>          <li style="background: #f3f3f3">                <span style="color: #0000ff">this</span>.end = <span style="color: #0000ff">value</span>; </li>          <li>                <span style="color: #0000ff">this</span>.RaisePropertyChanged(<span style="color: #a31515">"End"</span>); </li>          <li style="background: #f3f3f3">            } </li>          <li>        } </li>          <li style="background: #f3f3f3">    } </li>          <li>} </li>       </ol>     </div>   </div> </div>  <p> </p>  <p>With a simple attribute on each, the Start and End properties now import all of the validation attributes from their corresponding Model properties on the Meeting type; no more validation duplication!  When the property name is the same on the Model and the ViewModel, you can get away with only specifying the model type, but I also have an overload that accepts the model property name in case the property names differ.</p>  <h3>ModelObjectValidator</h3>  <p>Just as there are cases when you want a ViewModel property to import the validation attributes from a model property, there are also times when you want a ViewModel class to import a model’s object-level validation attributes.  That’s where ModelObjectValidatorAttribute comes in.  Very similarly to the ModelPropertyValidator, you just put the attribute on the ViewModel and specify the corresponding model type.</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:57b45adf-a303-46cf-85ef-8bdc59e3e945" class="wlWriterSmartContent">   <div style="border-bottom: #000080 1px solid; border-left: #000080 1px solid; font-family: 'Courier New', courier, monospace; color: #000; font-size: 10pt; border-top: #000080 1px solid; border-right: #000080 1px solid">     <div style="padding-bottom: 2px; padding-left: 5px; padding-right: 5px; font-family: verdana, tahoma, arial, sans-serif; background: #000080; color: #fff; font-weight: bold; padding-top: 2px">Code Snippet</div>      <div style="background: #ddd; max-height: 300px; overflow: auto">       <ol style="padding-bottom: 0px; margin: 0px 0px 0px 2em; padding-left: 5px; padding-right: 0px; background: #ffffff; padding-top: 0px">         <li>[<span style="color: #2b91af">ModelObjectValidator</span>(<span style="color: #0000ff">typeof</span>(<span style="color: #2b91af">Meeting</span>))] </li>          <li style="background: #f3f3f3"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> <span style="color: #2b91af">MeetingEntryViewModel</span> : <span style="color: #2b91af">ViewModelBase</span>, <span style="color: #2b91af">IStartAndEnd</span> </li>          <li>{ </li>          <li style="background: #f3f3f3">    <span style="color: #0000ff">private</span> <span style="color: #2b91af">DateTime</span> start; </li>          <li>    <span style="color: #0000ff">private</span> <span style="color: #2b91af">DateTime</span> end; </li>       </ol>     </div>   </div> </div>  <p> </p>  <p>That’s all there is to it.  Now the MeetingEntryViewModel class imports the object-level validation from the Meeting type.  You can even specify multiple ModelObjectValidator attributes if you want to import validation attributes from multiple classes.</p>  <h3>How’d you do that?</h3>  <p>Here’s how it works:</p>  <ol>   <li>ModelPropertyValidatorAttribute and ModelObjectValidatorAttribute both derive from ModelValidatorAttribute </li>    <li>ModelValidatorAttribute is an abstract class that derives from ValidationAttribute </li>    <li>ModelValidatorAttribute overrides IsValid and performs much of the same work that Validator performs, iterating over the attributes on the target and producing validation errors as ValidationResult instances </li>    <li>If the ViewModel derives from the RIA Services ComplexObject class, then there’s a nice ValidationErrors property that can be used to add multiple error messages </li>    <li>Otherwise, the first validation error is returned as the error message from this custom validator </li> </ol>  <p>Yes, I suggested that you make your ViewModel classes derive from ComplexObject.  ComplexObject is a really useful class and it exposes a great ValidationErrors collection that any consumer can manipulate, and all updates to that collection generate events from the INotifyDataErrorInfo interface.  This works perfectly for this scenario where I want my validation attribute to be able to push multiple validation results onto the target object, despite the fact that the IsValid method is only capable of returning a single error.</p>  <p>Here’s the full code for the ModelValidatorAttribute and the two derived forms.</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:ca92c7da-44b2-4888-af78-92f7747b492c" class="wlWriterSmartContent">   <div style="border-bottom: #000080 1px solid; border-left: #000080 1px solid; font-family: 'Courier New', courier, monospace; color: #000; font-size: 10pt; border-top: #000080 1px solid; border-right: #000080 1px solid">     <div style="padding-bottom: 2px; padding-left: 5px; padding-right: 5px; font-family: verdana, tahoma, arial, sans-serif; background: #000080; color: #fff; font-weight: bold; padding-top: 2px">Code Snippet</div>      <div style="background: #ddd; max-height: 300px; overflow: auto">       <ol style="padding-bottom: 0px; margin: 0px 0px 0px 3em; padding-left: 5px; padding-right: 0px; background: #ffffff; padding-top: 0px">         <li><span style="color: #0000ff">using</span> System; </li>          <li style="background: #f3f3f3"><span style="color: #0000ff">using</span> System.Collections.Generic; </li>          <li><span style="color: #0000ff">using</span> System.ComponentModel.DataAnnotations; </li>          <li style="background: #f3f3f3"><span style="color: #0000ff">using</span> System.Linq; </li>          <li><span style="color: #0000ff">using</span> System.Reflection; </li>          <li style="background: #f3f3f3"><span style="color: #0000ff">using</span> System.ServiceModel.DomainServices.Client; </li>          <li>  </li>          <li style="background: #f3f3f3"><span style="color: #0000ff">namespace</span> RudeValidation.Helpers </li>          <li>{ </li>          <li style="background: #f3f3f3">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> <span style="color: #2b91af">ModelPropertyValidatorAttribute</span> : <span style="color: #2b91af">ModelValidatorAttribute</span> </li>          <li>    { </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">public</span> ModelPropertyValidatorAttribute(<span style="color: #2b91af">Type</span> modelType) </li>          <li>            : <span style="color: #0000ff">base</span>(modelType, <span style="color: #2b91af">ModelValidationMode</span>.InferProperty) { } </li>          <li style="background: #f3f3f3">  </li>          <li>        <span style="color: #0000ff">public</span> ModelPropertyValidatorAttribute(<span style="color: #2b91af">Type</span> modelType, <span style="color: #0000ff">string</span> propertyName) </li>          <li style="background: #f3f3f3">            : <span style="color: #0000ff">base</span>(modelType, propertyName) { } </li>          <li>    } </li>          <li style="background: #f3f3f3">  </li>          <li>    <span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> <span style="color: #2b91af">ModelObjectValidatorAttribute</span> : <span style="color: #2b91af">ModelValidatorAttribute</span> </li>          <li style="background: #f3f3f3">    { </li>          <li>        <span style="color: #0000ff">public</span> ModelObjectValidatorAttribute(<span style="color: #2b91af">Type</span> modelType) </li>          <li style="background: #f3f3f3">            : <span style="color: #0000ff">base</span>(modelType, <span style="color: #2b91af">ModelValidationMode</span>.Object) { } </li>          <li>    } </li>          <li style="background: #f3f3f3">  </li>          <li>    [<span style="color: #2b91af">AttributeUsage</span>(<span style="color: #2b91af">AttributeTargets</span>.Property | <span style="color: #2b91af">AttributeTargets</span>.Class | <span style="color: #2b91af">AttributeTargets</span>.Parameter, AllowMultiple = <span style="color: #0000ff">true</span>)] </li>          <li style="background: #f3f3f3">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">abstract</span> <span style="color: #0000ff">class</span> <span style="color: #2b91af">ModelValidatorAttribute</span> : <span style="color: #2b91af">ValidationAttribute</span> </li>          <li>    { </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">public</span> <span style="color: #2b91af">Type</span> ModelType { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">private</span> <span style="color: #0000ff">set</span>; } </li>          <li>        <span style="color: #0000ff">public</span> <span style="color: #2b91af">ModelValidationMode</span> ValidationMode { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">private</span> <span style="color: #0000ff">set</span>; } </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> ModelProperty { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">private</span> <span style="color: #0000ff">set</span>; } </li>          <li>  </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">private</span> <span style="color: #0000ff">object</span> model; </li>          <li>  </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">public</span> ModelValidatorAttribute(<span style="color: #2b91af">Type</span> modelType, <span style="color: #2b91af">ModelValidationMode</span> validationMode) </li>          <li>        { </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">this</span>.ModelType = modelType; </li>          <li>            <span style="color: #0000ff">this</span>.ValidationMode = validationMode; </li>          <li style="background: #f3f3f3">        } </li>          <li>  </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">public</span> ModelValidatorAttribute(<span style="color: #2b91af">Type</span> modelType, <span style="color: #0000ff">string</span> modelPropertyName) </li>          <li>        { </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">this</span>.ModelType = modelType; </li>          <li>            <span style="color: #0000ff">this</span>.ValidationMode = Helpers.<span style="color: #2b91af">ModelValidationMode</span>.SpecifiedProperty; </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">this</span>.ModelProperty = modelPropertyName; </li>          <li>        } </li>          <li style="background: #f3f3f3">  </li>          <li>        <span style="color: #0000ff">protected</span> <span style="color: #0000ff">override</span> <span style="color: #2b91af">ValidationResult</span> IsValid(<span style="color: #0000ff">object</span> value, <span style="color: #2b91af">ValidationContext</span> validationContext) </li>          <li style="background: #f3f3f3">        { </li>          <li>            <span style="color: #0000ff">if</span> (model == <span style="color: #0000ff">null</span>) </li>          <li style="background: #f3f3f3">            { </li>          <li>                model = <span style="color: #2b91af">Activator</span>.CreateInstance(<span style="color: #0000ff">this</span>.ModelType); </li>          <li style="background: #f3f3f3">            } </li>          <li>  </li>          <li style="background: #f3f3f3">            <span style="color: #2b91af">ValidationContext</span> redirectedContext = <span style="color: #0000ff">new</span> <span style="color: #2b91af">ValidationContext</span>(model, validationContext, validationContext.Items); </li>          <li>  </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">switch</span> (<span style="color: #0000ff">this</span>.ValidationMode) </li>          <li>            { </li>          <li style="background: #f3f3f3">                <span style="color: #0000ff">case</span> <span style="color: #2b91af">ModelValidationMode</span>.InferProperty: </li>          <li>                    redirectedContext.MemberName = validationContext.MemberName; </li>          <li style="background: #f3f3f3">                    <span style="color: #0000ff">break</span>; </li>          <li>                <span style="color: #0000ff">case</span> <span style="color: #2b91af">ModelValidationMode</span>.SpecifiedProperty: </li>          <li style="background: #f3f3f3">                    redirectedContext.MemberName = <span style="color: #0000ff">this</span>.ModelProperty; </li>          <li>                    <span style="color: #0000ff">break</span>; </li>          <li style="background: #f3f3f3">                <span style="color: #0000ff">case</span> <span style="color: #2b91af">ModelValidationMode</span>.Object: </li>          <li>                    redirectedContext.MemberName = <span style="color: #0000ff">null</span>; </li>          <li style="background: #f3f3f3">                    <span style="color: #0000ff">break</span>; </li>          <li>            } </li>          <li style="background: #f3f3f3">  </li>          <li>            <span style="color: #2b91af">ComplexObject</span> targetEntity = validationContext.ObjectInstance <span style="color: #0000ff">as</span> <span style="color: #2b91af">ComplexObject</span>; </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">var</span> breakOnFirstError = (targetEntity == <span style="color: #0000ff">null</span>); </li>          <li>            <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ValidationResult</span>&gt; validationResults = TryValidateProperty(value, validationContext, redirectedContext, breakOnFirstError); </li>          <li style="background: #f3f3f3">  </li>          <li>            <span style="color: #0000ff">if</span> (validationResults.Any()) </li>          <li style="background: #f3f3f3">            { </li>          <li>                <span style="color: #0000ff">if</span> (validationResults.Count() == 1) </li>          <li style="background: #f3f3f3">                { </li>          <li>                    <span style="color: #0000ff">return</span> validationResults.Single(); </li>          <li style="background: #f3f3f3">                } </li>          <li>  </li>          <li style="background: #f3f3f3">                <span style="color: #0000ff">if</span> (targetEntity != <span style="color: #0000ff">null</span>) </li>          <li>                { </li>          <li style="background: #f3f3f3">                    <span style="color: #0000ff">foreach</span> (<span style="color: #2b91af">ValidationResult</span> result <span style="color: #0000ff">in</span> validationResults.Skip(1)) </li>          <li>                    { </li>          <li style="background: #f3f3f3">                        targetEntity.ValidationErrors.Add(result); </li>          <li>                    } </li>          <li style="background: #f3f3f3">                } </li>          <li>  </li>          <li style="background: #f3f3f3">                <span style="color: #0000ff">return</span> validationResults.First(); </li>          <li>            } </li>          <li style="background: #f3f3f3">  </li>          <li>            <span style="color: #0000ff">return</span> <span style="color: #2b91af">ValidationResult</span>.Success; </li>          <li style="background: #f3f3f3">        } </li>          <li>  </li>          <li style="background: #f3f3f3">        <span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ValidationResult</span>&gt; TryValidateProperty(<span style="color: #0000ff">object</span> value, <span style="color: #2b91af">ValidationContext</span> validationContext, <span style="color: #2b91af">ValidationContext</span> modelValidationContext, <span style="color: #0000ff">bool</span> breakOnFirstError) </li>          <li>        { </li>          <li style="background: #f3f3f3">            <span style="color: #2b91af">ICustomAttributeProvider</span> validatorProvider; </li>          <li>  </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">if</span> (!<span style="color: #0000ff">string</span>.IsNullOrEmpty(modelValidationContext.MemberName)) </li>          <li>            { </li>          <li style="background: #f3f3f3">                validatorProvider = modelValidationContext.ObjectType.GetProperty(modelValidationContext.MemberName); </li>          <li>            } </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">else</span> </li>          <li>            { </li>          <li style="background: #f3f3f3">                validatorProvider = modelValidationContext.ObjectType; </li>          <li>            } </li>          <li style="background: #f3f3f3">  </li>          <li>            <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ValidationAttribute</span>&gt; validators = validatorProvider </li>          <li style="background: #f3f3f3">                .GetCustomAttributes(<span style="color: #0000ff">typeof</span>(<span style="color: #2b91af">ValidationAttribute</span>), <span style="color: #0000ff">true</span>) </li>          <li>                .Cast&lt;<span style="color: #2b91af">ValidationAttribute</span>&gt;(); </li>          <li style="background: #f3f3f3">  </li>          <li>            <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ValidationResult</span>&gt; results = GetValidationErrors(value, validationContext, validators, breakOnFirstError); </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">return</span> results; </li>          <li>        } </li>          <li style="background: #f3f3f3">  </li>          <li>        <span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ValidationResult</span>&gt; GetValidationErrors(<span style="color: #0000ff">object</span> value, <span style="color: #2b91af">ValidationContext</span> validationContext, <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ValidationAttribute</span>&gt; attributes, <span style="color: #0000ff">bool</span> breakOnFirstError) </li>          <li style="background: #f3f3f3">        { </li>          <li>            <span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">ValidationResult</span>&gt; errors = <span style="color: #0000ff">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">ValidationResult</span>&gt;(); </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">bool</span> hasErrors = <span style="color: #0000ff">false</span>; </li>          <li>            <span style="color: #2b91af">ValidationResult</span> result; </li>          <li style="background: #f3f3f3">  </li>          <li>            <span style="color: #0000ff">foreach</span> (<span style="color: #2b91af">RequiredAttribute</span> required <span style="color: #0000ff">in</span> attributes.OfType&lt;<span style="color: #2b91af">RequiredAttribute</span>&gt;()) </li>          <li style="background: #f3f3f3">            { </li>          <li>                result = required.GetValidationResult(value, validationContext); </li>          <li style="background: #f3f3f3">  </li>          <li>                <span style="color: #0000ff">if</span> (result != <span style="color: #2b91af">ValidationResult</span>.Success) </li>          <li style="background: #f3f3f3">                { </li>          <li>                    errors.Add(result); </li>          <li style="background: #f3f3f3">                    hasErrors = <span style="color: #0000ff">true</span>; </li>          <li>  </li>          <li style="background: #f3f3f3">                    <span style="color: #0000ff">if</span> (breakOnFirstError) </li>          <li>                    { </li>          <li style="background: #f3f3f3">                        <span style="color: #0000ff">return</span> errors; </li>          <li>                    } </li>          <li style="background: #f3f3f3">                } </li>          <li>            } </li>          <li style="background: #f3f3f3">  </li>          <li>            <span style="color: #0000ff">if</span> (hasErrors) </li>          <li style="background: #f3f3f3">            { </li>          <li>                <span style="color: #0000ff">return</span> errors; </li>          <li style="background: #f3f3f3">            } </li>          <li>  </li>          <li style="background: #f3f3f3">            <span style="color: #0000ff">foreach</span> (<span style="color: #2b91af">ValidationAttribute</span> attribute <span style="color: #0000ff">in</span> attributes) </li>          <li>            { </li>          <li style="background: #f3f3f3">                <span style="color: #0000ff">if</span> (attribute <span style="color: #0000ff">is</span> <span style="color: #2b91af">RequiredAttribute</span>) </li>          <li>                { </li>          <li style="background: #f3f3f3">                    <span style="color: #0000ff">continue</span>; </li>          <li>                } </li>          <li style="background: #f3f3f3">  </li>          <li>                result = attribute.GetValidationResult(value, validationContext); </li>          <li style="background: #f3f3f3">  </li>          <li>                <span style="color: #0000ff">if</span> (result != <span style="color: #2b91af">ValidationResult</span>.Success) </li>          <li style="background: #f3f3f3">                { </li>          <li>                    errors.Add(result); </li>          <li style="background: #f3f3f3">                    hasErrors = <span style="color: #0000ff">true</span>; </li>          <li>  </li>          <li style="background: #f3f3f3">                    <span style="color: #0000ff">if</span> (breakOnFirstError) </li>          <li>                    { </li>          <li style="background: #f3f3f3">                        <span style="color: #0000ff">return</span> errors; </li>          <li>                    } </li>          <li style="background: #f3f3f3">                } </li>          <li>            } </li>          <li style="background: #f3f3f3">  </li>          <li>            <span style="color: #0000ff">return</span> errors; </li>          <li style="background: #f3f3f3">        } </li>          <li>    } </li>          <li style="background: #f3f3f3">  </li>          <li>    <span style="color: #0000ff">public</span> <span style="color: #0000ff">enum</span> <span style="color: #2b91af">ModelValidationMode</span> </li>          <li style="background: #f3f3f3">    { </li>          <li>        InferProperty, </li>          <li style="background: #f3f3f3">        SpecifiedProperty, </li>          <li>        Object </li>          <li style="background: #f3f3f3">    } </li>          <li>} </li>       </ol>     </div>   </div> </div>  <p> </p>  <h3>RIA Services Validation Recap</h3>  <p>This was the 10th installment in a blog post series about RIA Services Validation.  We’ve learned about the standard validators, how to create different types of custom validators, how the validation attributes get propagated, how to perform common cross-field and cross-entity validation, and now we have a utility for importing model rules into ViewModel classes.  Here’s the full series:</p>  <ol>   <ol>     <li><a href="http://jeffhandley.com/archive/2010/09/22/RiaServicesStandardValidators.aspx">Standard Validators</a> </li>      <li><a href="http://jeffhandley.com/archive/2010/09/25/RiaServicesCustomValidationMethods.aspx">Custom Validation Methods</a> </li>      <li><a href="http://jeffhandley.com/archive/2010/09/26/RiaServicesCustomReusableValidators.aspx">Custom Reusable Validators</a> </li>      <li><a href="http://jeffhandley.com/archive/2010/09/30/RiaServicesValidationAttributePropagation.aspx">Attribute Propagation</a> </li>      <li><a href="http://jeffhandley.com/archive/2010/10/06/RiaServicesValidationTriggers.aspx">Validation Triggers</a> </li>      <li><a href="http://jeffhandley.com/archive/2010/10/10/CrossFieldValidation.aspx">Cross-Field Validation</a> </li>      <li><a href="http://jeffhandley.com/archive/2010/10/12/EntityLevelValidation.aspx">Entity-Level Validation</a> </li>      <li><a href="http://jeffhandley.com/archive/2010/10/25/RiaServicesValidationContext.aspx">Providing ValidationContext</a> </li>      <li><a href="http://jeffhandley.com/archive/2010/10/25/CrossEntityValidation.aspx">Using ValidationContext (Cross-Entity Validation)</a> </li>      <li><a href="http://jeffhandley.com/archive/2011/09/06/ViewModelValidation.aspx">ViewModel Validation with Entity Rules</a> </li>   </ol> </ol>  <p><strong><em>The source code for everything shown during the series is <a href="http://jeffhandley.com/archive/2011/09/06/RIA-Services-Validation-Available-on-GitHub.aspx">available on GitHub</a>.</em></strong></p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:0767317B-992E-4b12-91E0-4F059A8CECA8:44bf9f0c-64be-43cb-8967-e2ec437badea" class="wlWriterSmartContent">Technorati Tags: <a href="http://technorati.com/tags/RiaServicesValidation" rel="tag">RiaServicesValidation</a>,<a href="http://technorati.com/tags/RIAServicesValidation" rel="tag">RIAServicesValidation</a>,<a href="http://technorati.com/tags/Validation" rel="tag">Validation</a>,<a href="http://technorati.com/tags/Silverlight" rel="tag">Silverlight</a>,<a href="http://technorati.com/tags/DataAnnotations" rel="tag">DataAnnotations</a></div>


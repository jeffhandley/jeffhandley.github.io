---
layout: post
title: "RIA Services Validation: Cross-Field Validation"
date: 2010-10-10 08:29:55 -0700
comments: true
tags: ["RiaServicesValidation", "RiaServices", "Validation", "Silverlight", "DataAnnotations"]
redirect_from: ["/archive/2010/10/10/CrossFieldValidation.aspx/", "/archive/2010/10/10/crossfieldvalidation.aspx"]
author: "Jeff Handley"
---
<!-- more -->
<p>I frequently hear questions about how to perform cross-field validation in RIA Services.  Before thoroughly covering this topic<em>*</em>, I wanted to be sure to go through some <a title="RIA Services Validation: Standard Validators" href="/archive/2010/09/22/RiaServicesStandardValidators.aspx" target="_blank">simple scenarios</a>, show <a title="RIA Services Validation: Custom Validation Methods" href="/archive/2010/09/25/RiaServicesCustomValidationMethods.aspx" target="_blank">how to use CustomValidationAttribute</a>, how to <a title="RIA Services Validation: Custom Reusable Validators" href="/archive/2010/09/26/RiaServicesCustomReusableValidators.aspx" target="_blank">derive from ValidationAttribute</a>, explain how validation rules are <a title="RIA Services Validation: Attribute Propagation" href="/archive/2010/09/30/RiaServicesValidationAttributePropagation.aspx" target="_blank">propagated</a> to the client, and what <a title="RIA Services Validation: Validation Triggers" href="/archive/2010/10/06/RiaServicesValidationTriggers.aspx" target="_blank">triggers</a> the validation.  Hopefully by now, you’re getting pretty comfortable with the validation framework and you’re ready to explore some more examples.</p>  <p><em>* Perhaps you noticed that I snuck a reusable cross-field validator into the <a title="RIA Services: Custom Reusable Validators (Conditionally Required Validator included)" href="/archive/2010/09/26/RiaServicesCustomReusableValidators.aspx" target="_blank">Custom Reusable Validators</a> post—it’s a rather useful ConditionallyRequiredAttribute.</em></p>  <p>In this post, I’m going to assume you now understand how to write cross-tier validation methods and attributes.  The code shown should be saved in a <em>.shared.cs</em> file so that it is automatically compiled into your Silverlight project.</p>  <h3>Custom Validation Method</h3>  <p>These requirements surface often: the validation rules for one field depend on a value in another field.  Continuing to use my Meeting entity, we can implement a validator that ensures that the End time for a meeting cannot be before the Start time for the meeting.  Let’s implement this using a [CustomValidation] attribute on the End time property.  Here’s a <strong>NoTimeTravel</strong> method that performs this cross-field validation.</p>  <div id="codeSnippetWrapper">   <pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #008000">/// &lt;summary&gt;</span><br /><span style="color: #008000">/// Validate that the end time for a meeting is not before the</span><br /><span style="color: #008000">/// start time for the meeting.</span><br /><span style="color: #008000">/// &lt;/summary&gt;</span><br /><span style="color: #008000">/// &lt;param name="end"&gt;The end time being validated.&lt;/param&gt;</span><br /><span style="color: #008000">/// &lt;param name="validationContext"&gt;</span><br /><span style="color: #008000">/// The validation context, which includes the meeting instance.</span><br /><span style="color: #008000">/// &lt;/param&gt;</span><br /><span style="color: #008000">/// &lt;returns&gt;</span><br /><span style="color: #008000">/// A &lt;see cref="ValidationResult"/&gt; with an error or &lt;see cref="ValidationResult.Success"/&gt;.</span><br /><span style="color: #008000">/// &lt;/returns&gt;</span><br /><span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> ValidationResult NoTimeTravel(DateTime end, ValidationContext validationContext)<br />{<br />    Meeting meeting = (Meeting)validationContext.ObjectInstance;<br /><br />  <span style="color: #0000ff">if</span> (meeting.Start &gt; end)<br />    {<br />  <span style="color: #0000ff">return</span> <span style="color: #0000ff">new</span> ValidationResult(<br />  <span style="color: #006080">"Meetings cannot result in time travel."</span>,<br />  <span style="color: #0000ff">new</span>[] { validationContext.MemberName });<br />    }<br /><br />  <span style="color: #0000ff">return</span> ValidationResult.Success;<br />}<br /></pre>

  <br /></div>

<p>The logic is pretty straight-forward.  Here are three tips that helped:</p>

<ol>
  <li>When using [CustomValidation], your validation method can accept a strongly-typed and well-named value parameter—in this case DateTime end; </li>

  <li>ValidationContext has the ObjectInstance which is the entity being validated and this can be cast to the expected entity type; </li>

  <li>For the End time value that is being validated, it’s important to validate the value specified as a parameter rather than getting the value from the ObjectInstance. </li>
</ol>

<p>For tip #3, the <a title="RIA Services Validation: Validation Triggers" href="/archive/2010/10/06/RiaServicesValidationTriggers.aspx" target="_blank">Validation Triggers</a> post explains why this is so important.  To reiterate though, property validation occurs BEFORE the value is set on the property.</p>

<p>Here’s how the <strong>NoTimeTravel</strong> validator is applied to our Meeting entity type:</p>

<div id="codeSnippetWrapper">
  <div id="codeSnippetWrapper">
  <div id="codeSnippetWrapper">
  <pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #0000ff">using</span> System;<br /><span style="color: #0000ff">using</span> System.ComponentModel.DataAnnotations;<br /><span style="color: #0000ff">using</span> RudeValidation.Web.Resources;<br /><span style="color: #0000ff">using</span> RudeValidation.Web.Validators;<br /> <br /><span style="color: #0000ff">namespace</span> RudeValidation.Web.Models<br />{<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">partial</span> <span style="color: #0000ff">class</span> Meeting<br />    {<br />        [Key]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> MeetingId { get; set; }<br /> <br />        [Required]<br />        [CustomValidation(<span style="color: #0000ff">typeof</span>(MeetingValidators), <span style="color: #006080">"NoEarlyMeetings"</span>)]<br />        [DateValidator(DateValidatorType.Future)]<br />  <span style="color: #0000ff">public</span> DateTime Start { get; set; }<br /> <br />        [Required]<br /><font style="background-color: #ffff00">        [CustomValidation(<span style="color: #0000ff">typeof</span>(MeetingValidators), <span style="color: #006080">"NoTimeTravel"</span>)]</font><br />  <span style="color: #0000ff">public</span> DateTime End { get; set; }<br /> <br />        [Required]<br />        [StringLength(80, MinimumLength = 5,<br />            ErrorMessageResourceType = <span style="color: #0000ff">typeof</span>(ValidationErrorResources),<br />            ErrorMessageResourceName = <span style="color: #006080">"TitleStringLengthErrorMessage"</span>)]<br />  <span style="color: #008000">// {0} must be at least {2} characters and no more than {1}.</span><br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Title { get; set; }<br /> <br />        [ConditionallyRequired(<span style="color: #006080">"IsLongMeeting"</span>,<br />            ErrorMembers = <span style="color: #006080">"Start, End"</span>,<br />            ErrorMessage = <span style="color: #006080">"If you're asking for more than an hour of time, provide an agenda."</span>)]<br />        [ConditionallyRequired(<span style="color: #006080">"Location"</span>, <span style="color: #006080">"18/3367"</span>,<br />            ErrorMessage = <span style="color: #006080">"No one can ever find this room; please be sure to include directions."</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Details { get; set; }<br /> <br />        [Required]<br />        [RegularExpression(<span style="color: #006080">@"\d{1,3}/\d{4}"</span>,<br />            ErrorMessage = <span style="color: #006080">"{0} must be in the format of 'Building/Room'"</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Location { get; set; }<br /> <br />        [Range(2, 100)]<br />        [Display(Name = <span style="color: #006080">"Minimum Attendees"</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> MinimumAttendees { get; set; }<br /> <br />        [Range(2, 100)]<br />        [Display(Name = <span style="color: #006080">"Maximum Attendees"</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> MaximumAttendees { get; set; }<br />    }<br />}</pre>

  <br /></div>

  <div> </div>
  </div>

  <br />As applied, the following sequence of events will occur:</div>

<div> </div>

<ol>
  <li>User enters a start time; </li>

  <li>User enters an end time that is before the start time; </li>

  <li>A validation error is displayed; </li>

  <li>Changing the end time to a valid value will clear the error; </li>

  <li>Changing the start time to make the end time valid <em>will not</em> clear the error. </li>
</ol>

<p>A start time adjustment would not clear the error on the end time field, because the error does not indicate that the Start field was involved in the validation.  Furthermore, the NoTimeTravel validation would not be triggered from the start time change even if the error was cleared out, since the validation is only applied to the End property.  This behavior can often be acceptable or even desired.  But if you would like the cross-field validation to respond immediately to both fields, then we can refactor this validation method to accommodate that.</p>

<div id="codeSnippetWrapper">
  <pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #008000">/// &lt;summary&gt;</span><br /><span style="color: #008000">/// Validate that the end time for a meeting is not before the</span><br /><span style="color: #008000">/// start time for the meeting.</span><br /><span style="color: #008000">/// &lt;/summary&gt;</span><br /><span style="color: #008000">/// &lt;param name="time"&gt;The start or end time being validated.&lt;/param&gt;</span><br /><span style="color: #008000">/// &lt;param name="validationContext"&gt;</span><br /><span style="color: #008000">/// The validation context, which includes the meeting instance.</span><br /><span style="color: #008000">/// &lt;/param&gt;</span><br /><span style="color: #008000">/// &lt;returns&gt;</span><br /><span style="color: #008000">/// A &lt;see cref="ValidationResult"/&gt; with an error or &lt;see cref="ValidationResult.Success"/&gt;.</span><br /><span style="color: #008000">/// &lt;/returns&gt;</span><br /><span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> ValidationResult NoTimeTravel(DateTime time, ValidationContext validationContext)<br />{<br />    Meeting meeting = (Meeting)validationContext.ObjectInstance;<br /> <br />    DateTime start = validationContext.MemberName == <span style="color: #006080">"Start"</span> ? time : meeting.Start;<br />    DateTime end = validationContext.MemberName == <span style="color: #006080">"End"</span> ? time : meeting.End;<br /> <br />  <span style="color: #0000ff">if</span> (start &gt; end)<br />    {<br />  <span style="color: #0000ff">return</span> <span style="color: #0000ff">new</span> ValidationResult(<br />  <span style="color: #006080">"Meetings cannot result in time travel."</span>,<br />  <span style="color: #0000ff">new</span>[] { <span style="color: #006080">"Start"</span>, <span style="color: #006080">"End"</span> });<br />    }<br /> <br />  <span style="color: #0000ff">return</span> ValidationResult.Success;<br />}<br /></pre>

  <br /></div>

<div>We’ve made a few tweaks:</div>

<div> </div>

<ol>
  <li>The value parameter is now just called “time” as it can represent either the start time or the end time; </li>

  <li>We conditionally grab the start/end time values from either the time parameter or from the Meeting instance;
  <br /><em>Remember, for the property being validated, we must use the value parameter since the property still holds the old value</em> </li>

  <li>The ValidationResult returned has both the Start and End member names specified, so that both fields are highlighted and changes to either field would clear the error. </li>
</ol>

<p>In addition to these changes, we now apply the [CustomValidation] attribute to both the Start and End properties.</p>

<div id="codeSnippetWrapper">
  <pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #0000ff">using</span> System;<br /><span style="color: #0000ff">using</span> System.ComponentModel.DataAnnotations;<br /><span style="color: #0000ff">using</span> RudeValidation.Web.Resources;<br /><span style="color: #0000ff">using</span> RudeValidation.Web.Validators;<br /> <br /><span style="color: #0000ff">namespace</span> RudeValidation.Web.Models<br />{<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">partial</span> <span style="color: #0000ff">class</span> Meeting<br />    {<br />        [Key]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> MeetingId { get; set; }<br /> <br />        [Required]<br />        [CustomValidation(<span style="color: #0000ff">typeof</span>(MeetingValidators), <span style="color: #006080">"NoEarlyMeetings"</span>)]<br /><font style="background-color: #ffff00">        [CustomValidation(<span style="color: #0000ff">typeof</span>(MeetingValidators), <span style="color: #006080">"NoTimeTravel"</span>)]</font><br />        [DateValidator(DateValidatorType.Future)]<br />  <span style="color: #0000ff">public</span> DateTime Start { get; set; }<br /> <br />        [Required]<br /><font style="background-color: #ffff00">        [CustomValidation(<span style="color: #0000ff">typeof</span>(MeetingValidators), <span style="color: #006080">"NoTimeTravel"</span>)]</font><br />  <span style="color: #0000ff">public</span> DateTime End { get; set; }<br /> <br />        [Required]<br />        [StringLength(80, MinimumLength = 5,<br />            ErrorMessageResourceType = <span style="color: #0000ff">typeof</span>(ValidationErrorResources),<br />            ErrorMessageResourceName = <span style="color: #006080">"TitleStringLengthErrorMessage"</span>)]<br />  <span style="color: #008000">// {0} must be at least {2} characters and no more than {1}.</span><br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Title { get; set; }<br /> <br />        [ConditionallyRequired(<span style="color: #006080">"IsLongMeeting"</span>,<br />            ErrorMembers = <span style="color: #006080">"Start, End"</span>,<br />            ErrorMessage = <span style="color: #006080">"If you're asking for more than an hour of time, provide an agenda."</span>)]<br />        [ConditionallyRequired(<span style="color: #006080">"Location"</span>, <span style="color: #006080">"18/3367"</span>,<br />            ErrorMessage = <span style="color: #006080">"No one can ever find this room; please be sure to include directions."</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Details { get; set; }<br /> <br />        [Required]<br />        [RegularExpression(<span style="color: #006080">@"\d{1,3}/\d{4}"</span>,<br />            ErrorMessage = <span style="color: #006080">"{0} must be in the format of 'Building/Room'"</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Location { get; set; }<br /> <br />        [Range(2, 100)]<br />        [Display(Name = <span style="color: #006080">"Minimum Attendees"</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> MinimumAttendees { get; set; }<br /> <br />        [Range(2, 100)]<br />        [Display(Name = <span style="color: #006080">"Maximum Attendees"</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> MaximumAttendees { get; set; }<br />    }<br />}</pre>

  <br /></div>

<div> </div>

<div><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Cross-field validation: Meetings cannot result in time travel." border="0" alt="Cross-field validation: Meetings cannot result in time travel." src="/img/postimages/RIA-Services-Validation-Cross-Field-and-_14360/image_cfbc0e96-1cc5-492f-837f-7bc299ef591d.png" width="548" height="68" /></div>

<div>This pattern is what I find myself using most often for cross-field validation.  I love the benefits of immediate validation from both fields involved as well as the highlight of both fields.</div>

<div> </div>

<h3>Reusable Cross-Field Validators (CompareValidator)</h3>

<p>I already included a “Conditionally Required” validator in my <a title="RIA Services Validation: Custom Reusable Validators" href="/archive/2010/09/26/RiaServicesCustomReusableValidators.aspx" target="_blank">Custom Reusable Validators</a> post.  That’s certainly a very common scenario, but value comparisons like the Start/End time example above is another widely found validation requirement.  Because I wouldn’t want to have to write validation methods like <strong>NoTimeTravel</strong> above for every one of these scenarios, I have created a comparison validator that can be reused for these scenarios.</p>

<div id="codeSnippetWrapper">
  <pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><p><span style="color: #0000ff">using</span> System;<br /><span style="color: #0000ff">using</span> System.ComponentModel.DataAnnotations;<br /><span style="color: #0000ff">using</span> System.Linq;<br /><span style="color: #0000ff">using</span> System.Reflection;</p><p><br /><br /><span style="color: #0000ff">namespace</span> RudeValidation.Web.Validators<br />{<br />  <span style="color: #008000">/// &lt;summary&gt;</span><br />  <span style="color: #008000">/// Define the comparison operators for</span><br />  <span style="color: #008000">/// the &lt;see cref="CompareValidatorAttribute"/&gt;.</span><br />  <span style="color: #008000">/// &lt;/summary&gt;</span><br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">enum</span> CompareOperator<br />    {<br />        [Display(Name = <span style="color: #006080">"must be less than"</span>)]<br />        LessThan,<br /> <br />        [Display(Name = <span style="color: #006080">"cannot be more than"</span>)]<br />        LessThanEqual,<br /> <br />        [Display(Name = <span style="color: #006080">"must be the same as"</span>)]<br />        Equal,<br /> <br />        [Display(Name = <span style="color: #006080">"must be different from"</span>)]<br />        NotEqual,<br /> <br />        [Display(Name = <span style="color: #006080">"cannot be less than"</span>)]<br />        GreaterThanEqual,<br /> <br />        [Display(Name = <span style="color: #006080">"must be more than"</span>)]<br />        GreaterThan<br />    }<br /> <br />  <span style="color: #008000">/// &lt;summary&gt;</span><br />  <span style="color: #008000">/// A comparison validator that will compare a value to another property</span><br />  <span style="color: #008000">/// and validate that the comparison is valid.</span><br />  <span style="color: #008000">/// &lt;/summary&gt;</span><br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> CompareValidatorAttribute : ValidationAttribute<br />    {<br />  <span style="color: #0000ff">public</span> CompareValidatorAttribute(CompareOperator compareOperator, <span style="color: #0000ff">string</span> compareToProperty)<br />            : <span style="color: #0000ff">base</span>(<span style="color: #006080">"{0} {1} {2}"</span>)<br />        {<br />  <span style="color: #0000ff">this</span>.CompareOperator = compareOperator;<br />  <span style="color: #0000ff">this</span>.CompareToProperty = compareToProperty;<br />        }<br /> <br />  <span style="color: #0000ff">public</span> CompareOperator CompareOperator { get; <span style="color: #0000ff">private</span> set; }<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> CompareToProperty { get; <span style="color: #0000ff">private</span> set; }<br /> <br />  <span style="color: #008000">/// &lt;summary&gt;</span><br />  <span style="color: #008000">/// Cache the property info for the compare to property.</span><br />  <span style="color: #008000">/// &lt;/summary&gt;</span><br />  <span style="color: #0000ff">private</span> PropertyInfo _compareToPropertyInfo;<br /> <br />  <span style="color: #008000">/// &lt;summary&gt;</span><br />  <span style="color: #008000">/// Validate the value against the &lt;see cref="CompareProperty"/&gt;</span><br />  <span style="color: #008000">/// using the &lt;see cref="CompareOperator"/&gt;.</span><br />  <span style="color: #008000">/// &lt;/summary&gt;</span><br />  <span style="color: #008000">/// &lt;param name="value"&gt;The value being validated.&lt;/param&gt;</span><br />  <span style="color: #008000">/// &lt;param name="validationContext"&gt;The validation context.&lt;/param&gt;</span><br />  <span style="color: #008000">/// &lt;returns&gt;</span><br />  <span style="color: #008000">/// A &lt;see cref="ValidationResult"/&gt; if invalid or &lt;see cref="ValidationResult.Success"/&gt;.</span><br />  <span style="color: #008000">/// &lt;/returns&gt;</span><br />  <span style="color: #0000ff">protected</span> <span style="color: #0000ff">override</span> ValidationResult IsValid(<span style="color: #0000ff">object</span> <span style="color: #0000ff">value</span>, ValidationContext validationContext)<br />        {<br />  <span style="color: #008000">// Get the property that we need to compare to.</span><br />  <span style="color: #0000ff">this</span>._compareToPropertyInfo = validationContext.ObjectType<br />                .GetProperty(<span style="color: #0000ff">this</span>.CompareToProperty);<br /> <br />  <span style="color: #0000ff">object</span> compareToValue = <span style="color: #0000ff">this</span>._compareToPropertyInfo<br />                .GetValue(validationContext.ObjectInstance, <span style="color: #0000ff">null</span>);<br /> <br />  <span style="color: #0000ff">int</span> comparison = ((IComparable)<span style="color: #0000ff">value</span>).CompareTo(compareToValue);<br /> <br />  <span style="color: #0000ff">bool</span> isValid;<br />  <span style="color: #0000ff">if</span> (comparison &lt; 0)<br />            {<br />                isValid = <span style="color: #0000ff">this</span>.CompareOperator == CompareOperator.LessThan<br />                       || <span style="color: #0000ff">this</span>.CompareOperator == CompareOperator.LessThanEqual<br />                       || <span style="color: #0000ff">this</span>.CompareOperator == CompareOperator.NotEqual;<br />            }<br />  <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (comparison &gt; 0)<br />            {<br />                isValid = <span style="color: #0000ff">this</span>.CompareOperator == CompareOperator.GreaterThan<br />                       || <span style="color: #0000ff">this</span>.CompareOperator == CompareOperator.GreaterThanEqual<br />                       || <span style="color: #0000ff">this</span>.CompareOperator == CompareOperator.NotEqual;<br />            }<br />  <span style="color: #0000ff">else</span><br />            {<br />                isValid = <span style="color: #0000ff">this</span>.CompareOperator == CompareOperator.LessThanEqual<br />                       || <span style="color: #0000ff">this</span>.CompareOperator == CompareOperator.Equal<br />                       || <span style="color: #0000ff">this</span>.CompareOperator == CompareOperator.GreaterThanEqual;<br />            }<br /> <br />  <span style="color: #0000ff">if</span> (!isValid)<br />            {<br />  <span style="color: #0000ff">return</span> <span style="color: #0000ff">new</span> ValidationResult(<br />  <span style="color: #0000ff">this</span>.FormatErrorMessage(validationContext.DisplayName),<br />  <span style="color: #0000ff">new</span>[] { validationContext.MemberName, <span style="color: #0000ff">this</span>.CompareToProperty });<br />            }<br /> <br />  <span style="color: #0000ff">return</span> ValidationResult.Success;<br />        }<br /> <br />  <span style="color: #008000">/// &lt;summary&gt;</span><br />  <span style="color: #008000">/// Format the error message string using the property's</span><br />  <span style="color: #008000">/// name, the compare operator, and the comparison property's</span><br />  <span style="color: #008000">/// display name.</span><br />  <span style="color: #008000">/// &lt;/summary&gt;</span><br />  <span style="color: #008000">/// &lt;param name="name"&gt;The display name of the property validated.&lt;/param&gt;</span><br />  <span style="color: #008000">/// &lt;returns&gt;The formatted error message.&lt;/returns&gt;</span><br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">override</span> <span style="color: #0000ff">string</span> FormatErrorMessage(<span style="color: #0000ff">string</span> name)<br />        {<br />  <span style="color: #0000ff">return</span> <span style="color: #0000ff">string</span>.Format(<span style="color: #0000ff">this</span>.ErrorMessageString,<br />                                    name,<br />                                    GetOperatorDisplay(<span style="color: #0000ff">this</span>.CompareOperator),<br />                                    GetPropertyDisplay(<span style="color: #0000ff">this</span>._compareToPropertyInfo));<br />        }<br /> <br />  <span style="color: #008000">/// &lt;summary&gt;</span><br />  <span style="color: #008000">/// Get the display name for the specified compare operator.</span><br />  <span style="color: #008000">/// &lt;/summary&gt;</span><br />  <span style="color: #008000">/// &lt;param name="compareOperator"&gt;The operator.&lt;/param&gt;</span><br />  <span style="color: #008000">/// &lt;returns&gt;The display name for the operator.&lt;/returns&gt;</span><br />  <span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">string</span> GetOperatorDisplay(CompareOperator compareOperator)<br />        {<br />  <span style="color: #0000ff">return</span> <span style="color: #0000ff">typeof</span>(CompareOperator)<br />                .GetField(compareOperator.ToString())<br />                .GetCustomAttributes(<span style="color: #0000ff">typeof</span>(DisplayAttribute), <span style="color: #0000ff">false</span>)<br />                .Cast&lt;DisplayAttribute&gt;()<br />                .Single()<br />                .GetName();<br />        }<br /> <br />  <span style="color: #008000">/// &lt;summary&gt;</span><br />  <span style="color: #008000">/// Get the display name for the specified property.</span><br />  <span style="color: #008000">/// &lt;/summary&gt;</span><br />  <span style="color: #008000">/// &lt;param name="property"&gt;The property.&lt;/param&gt;</span><br />  <span style="color: #008000">/// &lt;returns&gt;The display name of the property.&lt;/returns&gt;</span><br />  <span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">string</span> GetPropertyDisplay(PropertyInfo property)<br />        {<br />            DisplayAttribute attribute = property<br />                .GetCustomAttributes(<span style="color: #0000ff">typeof</span>(DisplayAttribute), <span style="color: #0000ff">false</span>)<br />                .Cast&lt;DisplayAttribute&gt;()<br />                .SingleOrDefault();<br /><br />  <span style="color: #0000ff">return</span> attribute != <span style="color: #0000ff">null</span> ? attribute.GetName() : property.Name;<br />        }<br />    }<br />}</p></pre>

  <br /></div>

<p>Ignoring the implementation of the actual comparison, there are some details I’d like to point out about this custom validation attribute implementation.</p>

<ol>
  <li>The CompareOperator enum is not nested within the CompareValidatorAttribute class – <strong>RIA Services does not support nested types</strong>; </li>

  <li>The CompareValidatorAttribute constructor calls the base constructor specifying an error message string format, using placeholders; </li>

  <li>The IsValid method uses ValidationContext.ObjectType to easily get the type of the object being validated; </li>

  <li>The ValidationResult instance returned specifies both the MemberName being validated as well as the CompareToProperty, so that both fields are highlighted and changes to either field would clear this error; </li>

  <li>The ValidationResult instance returned uses FormatErrorMessage, using the ErrorMessageString property from the base class; </li>

  <li>FormatErrorMessage is overridden to format the string using the 3 placeholders specified in the default error message format on the constructor; </li>

  <li>Consumption of DisplayAttribute uses the GetName() method rather than the Name property—this is critical to localization; I’ll explain why in a future post. </li>
</ol>

<p>You’ll notice that a couple of these points were related to the error message string.  These details are necessary to allow declarations of this attribute to specify custom error messages.</p>

<p>Let’s take a look at how the CompareValidatorAttribute can be applied to our Meeting model.  We’ll apply it a couple of times; first, we’ll replace the NoTimeTravel validation; second, we’ll validate the min/max attendees properties.</p>

<div id="codeSnippetWrapper">
  <pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #0000ff">using</span> System;<br /><span style="color: #0000ff">using</span> System.ComponentModel.DataAnnotations;<br /><span style="color: #0000ff">using</span> RudeValidation.Web.Resources;<br /><span style="color: #0000ff">using</span> RudeValidation.Web.Validators;<br /> <br /><span style="color: #0000ff">namespace</span> RudeValidation.Web.Models<br />{<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">partial</span> <span style="color: #0000ff">class</span> Meeting<br />    {<br />        [Key]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> MeetingId { get; set; }<br /> <br />        [Required]<br />        [CustomValidation(<span style="color: #0000ff">typeof</span>(MeetingValidators), <span style="color: #006080">"NoEarlyMeetings"</span>)]<br /><font style="background-color: #ffff00">  <span style="color: #008000">//[CustomValidation(typeof(MeetingValidators), "NoTimeTravel")]</span><br />        [CompareValidator(CompareOperator.LessThan, <span style="color: #006080">"End"</span>,<br />            ErrorMessage = <span style="color: #006080">"Meetings cannot result in time travel."</span>)]<br /></font>        [DateValidator(DateValidatorType.Future)]<br />  <span style="color: #0000ff">public</span> DateTime Start { get; set; }<br /> <br />        [Required]<br /><font style="background-color: #ffff00">  <span style="color: #008000">//[CustomValidation(typeof(MeetingValidators), "NoTimeTravel")]</span><br />        [CompareValidator(CompareOperator.GreaterThan, <span style="color: #006080">"Start"</span>,<br />            ErrorMessage = <span style="color: #006080">"Meetings cannot result in time travel."</span>)]<br /></font>  <span style="color: #0000ff">public</span> DateTime End { get; set; }<br /> <br />        [Required]<br />        [StringLength(80, MinimumLength = 5,<br />            ErrorMessageResourceType = <span style="color: #0000ff">typeof</span>(ValidationErrorResources),<br />            ErrorMessageResourceName = <span style="color: #006080">"TitleStringLengthErrorMessage"</span>)]<br />  <span style="color: #008000">// {0} must be at least {2} characters and no more than {1}.</span><br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Title { get; set; }<br /> <br />        [ConditionallyRequired(<span style="color: #006080">"IsLongMeeting"</span>,<br />            ErrorMembers = <span style="color: #006080">"Start, End"</span>,<br />            ErrorMessage = <span style="color: #006080">"If you're asking for more than an hour of time, provide an agenda."</span>)]<br />        [ConditionallyRequired(<span style="color: #006080">"Location"</span>, <span style="color: #006080">"18/3367"</span>,<br />            ErrorMessage = <span style="color: #006080">"No one can ever find this room; please be sure to include directions."</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Details { get; set; }<br /> <br />        [Required]<br />        [RegularExpression(<span style="color: #006080">@"\d{1,3}/\d{4}"</span>,<br />            ErrorMessage = <span style="color: #006080">"{0} must be in the format of 'Building/Room'"</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Location { get; set; }<br /> <br />        [Range(2, 100)]<br /><font style="background-color: #ffff00">        [CompareValidator(CompareOperator.LessThanEqual, <span style="color: #006080">"MaximumAttendees"</span>)]</font><br />        [Display(Name = <span style="color: #006080">"Minimum Attendees"</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> MinimumAttendees { get; set; }<br /> <br />        [Range(2, 100)]<br /><font style="background-color: #ffff00">        [CompareValidator(CompareOperator.GreaterThanEqual, <span style="color: #006080">"MinimumAttendees"</span>)]</font><br />        [Display(Name = <span style="color: #006080">"Maximum Attendees"</span>)]<br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> MaximumAttendees { get; set; }<br />    }<br />}</pre>

  <br /><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="CompareValidator: Maximum Attendees cannot be less than Minimum Attendees" border="0" alt="CompareValidator: Maximum Attendees cannot be less than Minimum Attendees" src="/img/postimages/RIA-Services-Validation-Cross-Field-and-_14360/image_e3ec9241-8268-4d0e-9184-d7b1d22dedd6.png" width="554" height="66" /></div>

<p> </p>

<h3>Cross-Field Validation Approaches</h3>

<p>We have now seen how cross-field validation can be applied using [CustomValidation] as well as with a derived ValidationAttribute.  I recommend starting out with [CustomValidation] when implementing cross-field validation rules, but as you start to recognize patterns of similar validation, that’s when you can extract custom ValidationAttribute classes to replace your custom validation methods.  That is precisely what we’ve done in this blog post and I have had success with this mindset.</p>

<h3>RIA Services Validation Recap</h3>

<p>This post was dedicated to cross-field validation, showing patterns for validating fields that are related to each other.  I had actually intended to cover entity-level validation in this post as well, but I decided to hold that for its own post (which will be next).</p>

<p>Here’s the list of blog posts in this RIA Services Validation series:</p>

<ol>
  <ol>
  <li><a title="RIA Services Validation: Standard Validators" href="http://jeffhandley.com/archive/2010/09/22/RiaServicesStandardValidators.aspx">Standard Validators</a> </li>

  <li><a title="RIA Services Validation: Custom Validation Methods" href="/archive/2010/09/25/RiaServicesCustomValidationMethods.aspx">Custom Validation Methods</a> </li>

  <li><a title="RIA Services Validation: Custom Reusable Validators" href="/archive/2010/09/26/RiaServicesCustomReusableValidators.aspx" target="_blank">Custom Reusable Validators</a> </li>

  <li><a title="RIA Services Validation: Attribute Propagation" href="/archive/2010/09/30/RiaServicesValidationAttributePropagation.aspx">Attribute Propagation</a> </li>

  <li><a href="/archive/2010/10/06/RiaServicesValidationTriggers.aspx">Validation Triggers</a> </li>

  <li><a title="RIA Services Validation: Cross-Field Validation" href="/archive/2010/10/10/CrossFieldValidation.aspx">Cross-Field Validation</a> </li>

  <li><a title="RIA Services Validation: Entity-Level Validation" href="/archive/2010/10/12/EntityLevelValidation.aspx">Entity-Level Validation</a> </li>

  <li><a title="RIA Services Validation: Providing ValidationContext" href="/archive/2010/10/25/RiaServicesValidationContext.aspx">Providing ValidationContext</a> </li>

  <li><a title="RIA Services Validation: Using ValidationContext (Cross-Entity Validation)" href="/archive/2010/10/25/CrossEntityValidation.aspx">Using ValidationContext (Cross-Entity Validation)</a> </li>

  <li><a title="RIA Services Validation: ViewModel Validation with Entity Rules" href="http://jeffhandley.com/archive/2011/09/06/ViewModelValidation.aspx">ViewModel Validation with Entity Rules</a> </li>
  </ol>
</ol>

<p><strong><em>[9/6/2011] The source code for everything shown during the series is <a title="RIA Services Validation: Available on GitHub" href="http://jeffhandley.com/archive/2011/09/06/RIA-Services-Validation-Available-on-GitHub.aspx">available on GitHub</a>.</em></strong></p>

<h3>Digging Deeper</h3>

<p>Yes, we will continue to dig deeper into RIA Services Validation.  As mentioned, the next installment will be dedicated to entity-level validation.  Still in this series, we’ll explore the power of ValidationContext and ViewModel validation.</p>




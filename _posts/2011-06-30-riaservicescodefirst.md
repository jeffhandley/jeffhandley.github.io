---
layout: post
title: "RIA Services EF Code First Support"
date: 2011-06-30 08:00:51 -0700
comments: true
category: Archive
tags: []
redirect_from: ["http://jeffhandley.github.io/archive/2011/06/30/RIAServicesCodeFirst.aspx", "http://jeffhandley.github.io/archive/2011/06/30/riaservicescodefirst.aspx"]
author: 0
---
<!-- more -->
<p>You’ve been <a title="WCF RIA Services Wish List" href="http://dotnet.uservoice.com/forums/57026-wcf-ria-services/suggestions/1579271-ef-dbcontext-code-first-domainservicedescription" target="_blank">asking for it</a> for what seems like forever now, and as of today, it’s available.  That’s right, WCF RIA Services now supports EntityFramework Code First!  Varun Puranik developed the feature, and <a title="Varun Puranik's Blog - WCF RIA Services Support for EF 4.1 and Code-First" href="http://varunpuranik.wordpress.com/2011/06/29/wcf-ria-services-support-for-ef-4-1-and-ef-code-first/" target="_blank">he has blogged about it</a>, including some very useful Code Snippets.  I recommend going to read his post first, and then coming back here.</p>  <h3>NuGet Baby!</h3>  <p>EF Code First support for RIA Services is the first feature where we’re using NuGet as the first distribution mechanism.  Only NuGet offers the ability to release features independently from one another (without flooding your Add/Remove Programs list anyway), and it was a great fit for getting EF Code First support in your hands as quickly as possible.</p>  <p>The NuGet package is <a title="RIAServices.EntityFramework on NuGet.org" href="http://nuget.org/List/Packages/RIAServices.EntityFramework" target="_blank">RIAServices.EntityFramework</a>, and it depends on <a title="EntityFramework on NuGet.org" href="http://nuget.org/List/Packages/EntityFramework" target="_blank">EntityFramework</a> 4.1.  This can be used with WCF RIA Services V1.0 RTM, SP1, or SP2.  You can find SP1 and SP2 <a title="silverlight.net/riaservices" href="http://silverlight.net/riaservices" target="_blank">on our site</a>.</p>  <p>We will also roll this feature into the WCF RIA Services Toolkit the next time we put out a release of the entire toolkit.</p>  <h3>Heads-Up</h3>  <p>With this release, there is no Domain Service Wizard support for your DbContext classes.  So when you do Add New Item and choose Domain Service Class, you won’t see your DbContext classes in the dialog.  But with the NuGet package and Varun’s VS Code Snippets, I suspect you won’t miss it much.  As Varun mentioned, we will be adding Domain Service Wizard support for your DbContext classes in WCF RIA Services V1.0 SP2.</p>  <p>There’s also a small gotcha that you need to be aware of.  In order to generate code into your Silverlight project, RIA Services has to inspect your DbContext at build time in order to get the entity types that are available.  If you have been using DbContext, you’re likely aware that simply creating and accessing a DbContext can actually create your database in SQL Express.  Chances are though, you don’t want this to happen at build time when RIA Services generates code.  In order to prevent this, there’s a small bit of code you need to add to your DbContext to null out your database initializer.  Varun illustrated this, and I’ll show it below too.</p>  <p>When using this feature, you will inevitably get a build warning along the lines of:</p>  <p><code>The attribute 'System.ComponentModel.DataAnnotations.DatabaseGeneratedAttribute' requires a reference to System.ComponentModel.DataAnnotations in the client project 'SilverlightApplication10'. Skipping generation of attribute. Please add a reference to System.ComponentModel.DataAnnotations to ensure generation of the attribute.</code></p>  <p>This is unavoidable at the moment, and you might have actually seen similar build warnings when using other DataAnnotations attributes that aren’t available in Silverlight.  This is where our code generation was trying to be smart, recognizing that your model has an attribute applied from the DataAnnotations namespace, but seeing that the attribute type isn’t available to your Silverlight project.  At the time we created that build warning messages, it was safe to assume this meant that you didn’t have a reference to DataAnnotations in your Silverlight project.  That is no longer true - EntityFramework 4.1 includes a DatabaseGeneratedAttribute type that is defined within the DataAnnotations namespace, but of course isn’t available in Silverlight.  You can just ignore this build warning. </p>  <p><strong><em>Update:</em></strong>    <br />Lastly, the day after we released this NuGet package, the Entity Framework team released a June CTP for EF.  That CTP is not yet supported for RIA Services.  We wanted to first get support in place for the released EntityFramework 4.1 bits, and we’ll work to target EntityFramework 4.2 as soon as we can.</p>  <h3>Zero to Nifty in 5 Minutes</h3>  <p>Let’s run through a super-quick-start for getting going with RIA Services and EF Code First.  This by no means is a guide to how to use EF Code First, but it illustrates how to use RIA Services with it in a basic example.</p>  <p>Before you begin, you must have WCF RIA Services (V1.0 RTM, SP1, or SP2) installed on your machine, as well as <a title="Install NuGet" href="http://nuget.codeplex.com/" target="_blank">NuGet</a>.</p>  <ol>   <li>File \ New Project \ Silverlight Application (or Silverlight Navigation Application, or Silverlight Business Application). </li>    <li>If you selected Silverlight Application or Silverlight Navigation Application, check the “Enable WCF RIA Services” box </li>    <li>Using your favorite gesture for adding NuGet packages, select and add ‘RIAServices.EntityFramework’ to your Web project      <ul>       <li>For instance, right-click on the Web project and select Manage NuGet Packages… </li>     </ul>   </li>    <li>Also add a NuGet package reference to ‘EntityFramework.Sample’ to get a sample blog model in your application </li>    <li>Open the Models\BlogContext.cs class you got from EntityFramework.Sample and add a default constructor      <br /><em>(this will only be needed until the next release of WCF RIA Services V1.0 SP2)</em>       <br />      <br />      <div id="codeSnippetWrapper">       <pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> BlogContext : DbContext {<br />    <span style="color: #0000ff">public</span> DbSet&lt;Post&gt; Posts { get; set; }<br />    <span style="color: #0000ff">public</span> DbSet&lt;Comment&gt; Comments { get; set; }<br /> <br />    <span style="color: #0000ff">public</span> BlogContext()<br />    {<br />        <span style="color: #008000">// Prevent database initialization at design-time</span><br />        <span style="color: #008000">// when RIA Services is generating code</span><br />        <span style="color: #0000ff">if</span> (HttpContext.Current == <span style="color: #0000ff">null</span>)<br />        {<br />            Database.SetInitializer&lt;BlogContext&gt;(<span style="color: #0000ff">null</span>);<br />        }<br />    }<br />}<br /></pre>

      <br /></div>
  </li>

  <li>Add a new class to your Web project using Add\Class… and name it BlogService.cs </li>

  <li>Make the class derive from DbDomainService&lt;BlogContext&gt; </li>

  <li>Add an [EnableClientAccess] attribute to the class </li>

  <li>Author your query, insert, update, and delete methods using the DbContext property on the DomainService, as well as the AttachAsModified extension method we provide. 
    <br />

    <br />

    <div id="codeSnippetWrapper">
      <pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">[EnableClientAccess]<br /><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> BlogService : DbDomainService&lt;BlogContext&gt;<br />{<br />    <span style="color: #0000ff">public</span> IQueryable&lt;Post&gt; GetPosts()<br />    {<br />        <span style="color: #0000ff">return</span> <span style="color: #0000ff">this</span>.DbContext.Posts.OrderByDescending(p =&gt; p.PublishDate).Take(5);<br />    }<br /><br />    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> InsertPost(Post post)<br />    {<br />        DbEntityEntry&lt;Post&gt; entityEntry = <span style="color: #0000ff">this</span>.DbContext.Entry(post);<br /><br />        <span style="color: #0000ff">if</span> ((entityEntry.State != EntityState.Detached))<br />        {<br />            entityEntry.State = EntityState.Added;<br />        }<br />        <span style="color: #0000ff">else</span><br />        {<br />            <span style="color: #0000ff">this</span>.DbContext.Posts.Add(post);<br />        }<br />    }<br /><br />    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> UpdatePost(Post post)<br />    {<br />        <span style="color: #0000ff">this</span>.DbContext.Posts.AttachAsModified(post, <span style="color: #0000ff">this</span>.ChangeSet.GetOriginal(post), <span style="color: #0000ff">this</span>.DbContext);<br />    }<br /><br />    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> DeletePost(Post post)<br />    {<br />        DbEntityEntry&lt;Post&gt; entityEntry = <span style="color: #0000ff">this</span>.DbContext.Entry(post);<br /><br />        <span style="color: #0000ff">if</span> ((entityEntry.State != EntityState.Deleted))<br />        {<br />            entityEntry.State = EntityState.Deleted;<br />        }<br />        <span style="color: #0000ff">else</span><br />        {<br />            <span style="color: #0000ff">this</span>.DbContext.Posts.Attach(post);<br />            <span style="color: #0000ff">this</span>.DbContext.Posts.Remove(post);<br />        }<br />    }<br />}<br /></pre>
    </div>
  </li>
</ol>

<p>As far as RIA Services / EF Code First goes, you’re done.  At this point, you can now go into the Silverlight application and do all of the things you expect to do with RIA Services.  As with other DomainServices, your client has no awareness of what data access layer you’re using.  Because of this, you can use the new DbDomainService with Silverlight 4, Silverlight 5, or with <a href="http://jeffhandley.com/archive/2011/04/13/RIAJS-jQuery-client-for-WCF-RIA-Services.aspx" target="_blank">RIA/JS</a>.</p>

<p>Because we don’t have Domain Service Wizard support (until the next release of WCF RIA Service V1.0 SP2), you might want to grab Varun’s VS Code Snippets to make the above code simpler to crank out for each of your entity types.</p>

<h3>How It Works</h3>

<p>Thanks to the power or NuGet, quite a bit was actually done for you by adding the package reference to RIAServices.EntityFramework.</p>

<ol>
  <li>Our NuGet package has a dependency on the EntityFramework 4.1 NuGet package, so that was installed for you. </li>

  <li>The NuGet package includes Microsoft.ServiceModel.DomainServices.EntityFramework, which added DbDomainService to the System.ServiceModel.DomainServices.EntityFramework namespace.  A reference to this assembly gets added. </li>

  <li>The NuGet package adds references to System.ServiceModel.DomainServices.Hosting and System.ServiceModel.DomainServices.Server </li>

  <li>The NuGet package transforms your web.config file to include the domainServices section definition, and the DomainServiceModule HTTP Module under both &lt;system.web&gt; and &lt;system.webServer&gt; </li>
</ol>

<p>Note that 2-4 in this list matches up with what the Domain Service Wizard would typically do for you.  So even though we don’t have wizard support with the NuGet package, you still don’t have to mess with references or web.config to use RIA Services.</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:0767317B-992E-4b12-91E0-4F059A8CECA8:447c60d8-5dbd-4824-b6c5-d74edeb19458" class="wlWriterSmartContent">Technorati Tags: <a href="http://technorati.com/tags/RIAServices" rel="tag">RIAServices</a>,<a href="http://technorati.com/tags/EntityFramework" rel="tag">EntityFramework</a></div>


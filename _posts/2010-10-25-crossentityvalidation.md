---
layout: post
title: "RIA Services Validation: Using ValidationContext (Cross-Entity Validation)"
date: 2010-10-25 08:56:35 -0700
comments: true
tags: ["RiaServicesValidation", "RiaServices", "Validation", "Silverlight", "DataAnnotations"]
redirect_from: ["/archive/2010/10/25/CrossEntityValidation.aspx/", "/archive/2010/10/25/crossentityvalidation.aspx"]
author: "Jeff Handley"
---
<!-- more -->
<p>In our <a title="RIA Services Validation: ValidationContext" href="/archive/2010/10/25/RiaServicesValidationContext.aspx" target="_blank">last post</a>, we learned how ValidationContext can be used to provide and consume state and services for validation methods to use.  Now, let’s take a quick look at how validation methods can actually use this information.  I’m going to include a bunch of code in this post, and I will rely on the code to be rather self-explanatory.</p>  <h3>Property-Level Validation</h3>  <p>In this property-level validation example, we need to validate that the location entered for a meeting is a valid location from our database.  We want this to work both on the server and on the client, but the data is available differently on the two tiers.  To abstract the data access away, we’ll create an IMeetingDataProvider interface and use that as our means for getting to the list of locations.</p>  <pre style="font-family: "><font face="Consolas"><font color="#000000"><font size="1">    </font></font><font size="1"><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">interface</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span><br /></font></font><font face="Consolas"><font size="1"><font color="#000000">    {<br />        </font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">Meeting</font></span><font color="#000000">&gt; Meetings { </font><span style="color: "><font color="#0000ff">get</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">; }<br />        </font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">Location</font></span><font color="#000000">&gt; Locations { </font><span style="color: "><font color="#0000ff">get</font></span></font><font color="#000000" size="1">; }<br />    }</font></font><br /></pre>

<p> </p>

<p>Now that we have the interface, both the DomainService and the DomainContext need to inject an implementation of IMeetingDataProvider into our ValidationContext.  Here’s the DomainService code:</p>

<pre style="font-family: "><font face="Consolas"><font color="#000000"><font size="1">    </font></font><font size="1"><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">MeetingService</font></span><font color="#000000"> : </font><span style="color: "><font color="#2b91af">LinqToEntitiesDomainService</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">MeetingStoreEntities</font></span><font color="#000000">&gt;, </font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span><br /></font></font><font face="Consolas"><font size="1"><font color="#000000">    {<br />        </font><span style="color: "><font color="#808080">///</font></span><span style="color: "><font color="#008000"> </font></span><span style="color: "><font color="#808080">&lt;summary&gt;</font></span><br /><font color="#000000">        </font><span style="color: "><font color="#808080">///</font></span><span style="color: "><font color="#008000"> Initialize the </font></span><font color="#808080"><span style="color: ">&lt;see cref=</span><span style="color: ">"DomainService"</span><span style="color: ">/&gt;</span></font><span style="color: "><font color="#008000">, setting the</font></span><br /><font color="#000000">        </font><span style="color: "><font color="#808080">///</font></span><span style="color: "><font color="#008000"> </font></span><font color="#808080"><span style="color: ">&lt;see cref=</span><span style="color: ">"ValidationContext"</span><span style="color: ">/&gt;</span></font><span style="color: "><font color="#008000"> with custom state and services.</font></span><br /><font color="#000000">        </font><span style="color: "><font color="#808080">///</font></span><span style="color: "><font color="#008000"> </font></span><span style="color: "><font color="#808080">&lt;/summary&gt;</font></span><br /><font color="#000000">        </font><span style="color: "><font color="#808080">///</font></span><span style="color: "><font color="#008000"> </font></span><font color="#808080"><span style="color: ">&lt;param name=</span><span style="color: ">"context"</span><span style="color: ">&gt;</span></font><br /><font color="#000000">        </font><span style="color: "><font color="#808080">///</font></span><span style="color: "><font color="#008000"> Represents the execution environment for the operations performed</font></span><br /><font color="#000000">        </font><span style="color: "><font color="#808080">///</font></span><span style="color: "><font color="#008000"> by a System.ServiceModel.DomainServices.Server.DomainService.</font></span><br /><font color="#000000">        </font><span style="color: "><font color="#808080">///</font></span><span style="color: "><font color="#008000"> </font></span><span style="color: "><font color="#808080">&lt;/param&gt;</font></span><br /><font color="#000000">        </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">override</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">void</font></span><font color="#000000"> Initialize(</font><span style="color: "><font color="#2b91af">DomainServiceContext</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> context)<br />        {<br />            </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> contextItems = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">Dictionary</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#0000ff">object</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">object</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">&gt;<br />            {<br />                { </font><span style="color: "><font color="#a31515">"AllowOverBooking"</font></span><font color="#000000">, </font><span style="color: "><font color="#2b91af">HttpContext</font></span><font color="#000000">.Current.Session[</font><span style="color: "><font color="#a31515">"AllowOverBooking"</font></span><font color="#000000">] ?? </font><span style="color: "><font color="#0000ff">false</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> }<br />            };<br /> <br />            </font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">.ValidationContext = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">ValidationContext</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">this</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">, context, contextItems);<br />            </font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">.ValidationContext.ServiceContainer.AddService(</font><span style="color: "><font color="#0000ff">typeof</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span><font color="#000000">), </font><span style="color: "><font color="#0000ff">this</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">);<br /> <br />            </font><span style="color: "><font color="#0000ff">base</font></span></font><font color="#000000" size="1">.Initialize(context);<br />        }</font></font></pre>

<pre style="font-family: "><font color="#000000" size="1" face="Consolas">        ...</font></pre>

<pre style="font-family: "><font face="Consolas"><font size="1"><font color="#000000">        </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">Meeting</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">&gt; Meetings<br />        {<br />            </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000"> { </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">this</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">.ObjectContext.Meetings; }<br />        }<br /> <br />        </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">Location</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">&gt; Locations<br />        {<br />            </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000"> { </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">this</font></span></font><font color="#000000" size="1">.ObjectContext.Locations; }<br />        }</font></font></pre>

<pre style="font-family: "><font color="#000000" face="Consolas">    }</font><br /></pre>

<p>And here’s the DomainContext code.  Notice that we’re taking advantage of the fact that every DomainContext is generated as a partial class, so we can easily add interface implementations.</p>

<pre style="font-family: "><font face="Consolas"><font color="#000000"><font size="1">    </font></font><font size="1"><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">sealed</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">partial</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">MeetingContext</font></span><font color="#000000"> : </font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span><br /></font></font><font face="Consolas"><font size="1"><font color="#000000">    {<br />        </font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">Meeting</font></span><font color="#000000">&gt; </font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">.Meetings<br />        {<br />            </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000"> { </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">this</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">.Meetings; }<br />        }<br /> <br />        </font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">Location</font></span><font color="#000000">&gt; </font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">.Locations<br />        {<br />            </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000"> { </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">this</font></span></font><font color="#000000" size="1">.Locations; }<br />        }<br />    }</font></font></pre>

<p> </p>

<p>Consumers of the DomainContext must create the custom ValidationContext to use for validation:</p>

<pre style="font-family: "><font face="Consolas"><font size="1"><font color="#000000">    </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> contextItems = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">Dictionary</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#0000ff">object</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">object</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">&gt;<br />    {<br />        { </font><span style="color: "><font color="#a31515">"AllowOverBooking"</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">.allowOverBooking.IsChecked ?? </font><span style="color: "><font color="#0000ff">false</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> }<br />    };<br /> <br />    </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> contextServiceProvider = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">SimpleServiceProvider</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">();<br />    contextServiceProvider.AddService&lt;</font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span><font color="#000000">&gt;(</font><span style="color: "><font color="#0000ff">this</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">.meetingContext);<br /> <br />    </font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">.meetingContext.ValidationContext = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">ValidationContext</font></span></font></font><font size="1"><font face="Consolas"><font color="#000000">(<br />        </font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">.meetingContext, contextServiceProvider, contextItems);</font></font><br /></font></pre>

<p> </p>

<p>The plumbing is now in place:</p>

<ol>
  <li>Both the DomainService and the DomainContext provide our Meetings and Locations to be consumed through an IMeetingDataProvider interface; </li>

  <li>The interface is registered as a service within the ValidationContext, making it available through ValidationContext.GetService(typeof(IMeetingDataProvider)). </li>
</ol>

<p>We can now create a new validation method that will verify the location entered is valid.  We’ll create it in the MeetingValidators class that is a .shared.cs file, making it available to both the server and the client.</p>

<pre style="font-family: "><font face="Consolas"><font size="1"><font color="#000000">    </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">ValidationResult</font></span><font color="#000000"> IsValidLocation(</font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> location, </font><span style="color: "><font color="#2b91af">ValidationContext</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> validationContext)<br />    {<br />        </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (!</font><span style="color: "><font color="#0000ff">string</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">.IsNullOrEmpty(location))<br />        {<br />            </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> meetingData = validationContext.GetService(</font><span style="color: "><font color="#0000ff">typeof</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">))<br />                </font><span style="color: "><font color="#0000ff">as</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">;<br /> <br />            </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (meetingData != </font><span style="color: "><font color="#0000ff">null</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">)<br />            {<br />                </font><span style="color: "><font color="#0000ff">if</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> (!meetingData.Locations.Any(l =&gt; l.LocationName == location))<br />                {<br />                    </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">ValidationResult</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">(<br />                        </font><span style="color: "><font color="#a31515">"That is not a valid location"</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">,<br />                        </font><span style="color: "><font color="#0000ff">new</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">[] { validationContext.MemberName });<br />                }<br />            }<br />        }<br /> <br />        </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">ValidationResult</font></span></font><font color="#000000" size="1">.Success;<br />    }</font></font><br /></pre>

<p> </p>

<p>We apply this validation rule to our Meeting entity by adding another attribute to the Location property.</p>

<pre style="font-family: "><font face="Consolas"><font size="1"><font color="#000000">    [</font><span style="color: "><font color="#2b91af">Required</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">]<br />    [</font><span style="color: "><font color="#2b91af">RegularExpression</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">@"\d{1,3}/\d{4}"</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">,<br />        ErrorMessage = </font><span style="color: "><font color="#a31515">"{0} must be in the format of 'Building/Room'"</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">)]<br />    <font style="background-color: #ffff00">[</font></font><font style="background-color: #ffff00"><span style="color: "><font color="#2b91af">CustomValidation</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">typeof</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">MeetingValidators</font></span><font color="#000000">), </font><span style="color: "><font color="#a31515">"IsValidLocation"</font></span></font></font></font><font face="Consolas"><font size="1"><font color="#000000"><font style="background-color: #ffff00">)]</font><br />    [</font><span style="color: "><font color="#2b91af">Display</font></span></font></font><font size="1"><font face="Consolas"><font color="#000000">(Order = 3)]<br />    </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> Location { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span><font color="#000000">; }</font></font><br /></font></pre>

<p> </p>

<p>The last thing to do is to make sure the Location list is loaded into our ValidationContext before users start entering new meetings.  This can be done through a standard Load call, when the screen is first being loaded.</p>

<pre style="font-family: "><font size="1"><font face="Consolas"><span style="color: "><font color="#0000ff">    this</font></span><font color="#000000">.meetingContext.Load(</font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">.meetingContext.GetLocationsQuery());</font></font><br /></font></pre>

<p> </p>

<p>When we run the application, we can now enter an invalid meeting location and get an error message that integrates directly into our UI just like every other validator.</p>

<p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="That is not a valid location" border="0" alt="That is not a valid location" src="/img/postimages/RIA-Services-Validation-Cross-Entity-Val_CE8/image_c50b84e0-e1b4-4c84-b9f1-f3867cdf4c04.png" width="602" height="57" /></p>

<p> </p>

<h3>Entity-Level Validation (Cross-Entity)</h3>

<p>Just as our property-level validators can become more powerful using ValidationContext, our entity-level validators can gain capabilities too.  We can perform cross-entity validation.  In this example, we’ll build upon what we’ve wired up above to ensure that locations are not double-booked.  But we’ll also leverage another capability of our ValidationContext, showing how the Items dictionary can be used to perform context-sensitive validation.  In this case, we’ll store a flag for whether or not the user can over-book a location.</p>

<p>We’ll simply add a ToggleButton to the view that toggles our “Allow Over-Booking” mode.  When this ToggleButton is clicked, we need to alter the client-side ValidationContext, but we also need to inform the server that the state has changed.  We can create a RIA Services Invoke method within our DomainService to allow this.</p>

<pre style="font-family: "><font face="Consolas"><font size="1"><font color="#000000">    [</font><span style="color: "><font color="#2b91af">Invoke</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">]<br />    </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">void</font></span><font color="#000000"> SetOverBookingSetting(</font><span style="color: "><font color="#0000ff">bool</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> allowOverBooking)<br />    {<br />        </font><span style="color: "><font color="#2b91af">HttpContext</font></span><font color="#000000">.Current.Session[</font><span style="color: "><font color="#a31515">"AllowOverBooking"</font></span></font><font color="#000000" size="1">] = allowOverBooking;<br />    }</font></font><br /></pre>

<p> </p>

<p>Now when our ToggleButton is clicked, we can execute two simple lines of code to toggle our validation state.</p>

<pre style="font-family: "><font face="Consolas"><font size="1"><font color="#000000">    </font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">.meetingContext.ValidationContext.Items[</font><span style="color: "><font color="#a31515">"AllowOverBooking"</font></span><font color="#000000">] = </font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">.allowOverBooking.IsChecked ?? </font><span style="color: "><font color="#0000ff">false</font></span></font></font><font size="1"><font face="Consolas"><font color="#000000">;<br />    </font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">.meetingContext.SetOverBookingSetting(</font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">.allowOverBooking.IsChecked ?? </font><span style="color: "><font color="#0000ff">false</font></span><font color="#000000">);</font></font><br /></font></pre>

<p> </p>

<p>In our DomainService code above, you might have noticed that our Initialize method checked the AllowOverBooking session value to set the corresponding ValidationContext dictionary item.  The matching code for the DomainContext also seeded this item by checking the state of the ToggleButton when the ValidationContext was being created.</p>

<p>Also in our DomainService and DomainClient ValidationContext creation code, we made the Meetings collection available through an IMeetingDataProvider interface.  That means validation methods can access the list of meetings available.  On the client, we will validate that there aren’t any conflicts with other meetings loaded on the client, and on the server, we’ll be validating that there are <em>no</em> meetings that conflict, since we’ll have access to the full database.</p>

<p>Let’s take a look at the validation method.</p>

<pre style="font-family: "><font face="Consolas"><font size="1"><font color="#000000">    </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">ValidationResult</font></span><font color="#000000"> PreventDoubleBooking(</font><span style="color: "><font color="#2b91af">Meeting</font></span><font color="#000000"> meeting, </font><span style="color: "><font color="#2b91af">ValidationContext</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> validationContext)<br />    {<br />        </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (validationContext.Items.ContainsKey(</font><span style="color: "><font color="#a31515">"AllowOverBooking"</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">))<br />        {<br />            </font><span style="color: "><font color="#0000ff">bool</font></span><font color="#000000"> allowOverBooking = (</font><span style="color: "><font color="#0000ff">bool</font></span><font color="#000000">)validationContext.Items[</font><span style="color: "><font color="#a31515">"AllowOverBooking"</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">];<br /> <br />            </font><span style="color: "><font color="#0000ff">if</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> (!allowOverBooking)<br />            {<br />                </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> meetingData = validationContext.GetService(</font><span style="color: "><font color="#0000ff">typeof</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">))<br />                    </font><span style="color: "><font color="#0000ff">as</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">IMeetingDataProvider</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">;<br /> <br />                </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (meetingData != </font><span style="color: "><font color="#0000ff">null</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">)<br />                {<br />                    </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> conflicts = </font><span style="color: "><font color="#0000ff">from</font></span><font color="#000000"> other </font><span style="color: "><font color="#0000ff">in</font></span><font color="#000000"> meetingData.Meetings.Except(</font><span style="color: "><font color="#0000ff">new</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">[] { meeting })<br />                                    </font><span style="color: "><font color="#0000ff">where</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> other.Location == meeting.Location<br />                                    </font><span style="color: "><font color="#008000">// Check for conflicts by seeing if the times overlap in any way</font></span><br /></font></font><font face="Consolas"><font size="1"><font color="#000000">                                    &amp;&amp; (<br />                                        (other.Start &gt;= meeting.Start &amp;&amp; other.Start &lt;= meeting.End) ||<br />                                        (meeting.Start &gt;= other.Start &amp;&amp; meeting.Start &lt;= other.End) ||<br />                                        (other.End &gt;= meeting.Start &amp;&amp; other.End &lt;= meeting.End) ||<br />                                        (meeting.End &gt;= other.Start &amp;&amp; meeting.End &lt;= other.End)<br />                                        )<br />                                    </font><span style="color: "><font color="#0000ff">select</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> other;<br /> <br />                    </font><span style="color: "><font color="#0000ff">if</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> (conflicts.Any())<br />                    {<br />                        </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">ValidationResult</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">(<br />                            </font><span style="color: "><font color="#a31515">"The location selected is already booked at this time."</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">,<br />                            </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">[] { </font><span style="color: "><font color="#a31515">"Location"</font></span><font color="#000000">, </font><span style="color: "><font color="#a31515">"Start"</font></span><font color="#000000">, </font><span style="color: "><font color="#a31515">"End"</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000"> });<br />                    }<br />                }<br />            }<br />        }<br /> <br />        </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">ValidationResult</font></span></font><font color="#000000" size="1">.Success;<br />    }</font></font><br /></pre>

<p> </p>

<p>We apply this to our Meeting entity with an attribute on the class easily enough:</p>

<pre style="font-family: "><font face="Consolas"><font size="1"><font color="#000000">    [</font><span style="color: "><font color="#2b91af">CustomValidation</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">typeof</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">MeetingValidators</font></span><font color="#000000">), </font><span style="color: "><font color="#a31515">"PreventExpensiveMeetings"</font></span></font></font><font face="Consolas"><font size="1"><font color="#000000">)]<br />    <font style="background-color: #ffff00">[</font></font><font style="background-color: #ffff00"><span style="color: "><font color="#2b91af">CustomValidation</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">typeof</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">MeetingValidators</font></span><font color="#000000">), </font><span style="color: "><font color="#a31515">"PreventDoubleBooking"</font></span></font></font></font><font face="Consolas"><font size="1"><font color="#000000"><font style="background-color: #ffff00">)]</font><br />    [</font><span style="color: "><font color="#2b91af">MetadataType</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">typeof</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">Meeting</font></span><font color="#000000">.</font><span style="color: "><font color="#2b91af">MeetingMetadata</font></span></font></font><font size="1"><font face="Consolas"><font color="#000000">))]<br />    </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">partial</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">Meeting</font></span></font><br /></font></pre>

<p> </p>

<p>And now, when we attempt to save a meeting that would result in a meeting being double-booked, we get an integrated validation error.</p>

<p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/img/postimages/RIA-Services-Validation-Cross-Entity-Val_CE8/image_0194f5e1-b47b-4fb7-9784-1ae0817a3ec3.png" width="517" height="394" /></p>

<p>But if the user clicks the “Allow Over Booking” button, then the validation rule is turned off, and the meeting can be saved.</p>

<h3>RIA Services Validation Recap</h3>

<p>This code-heavy post shows examples of how you can leverage ValidationContext to perform intelligent property-level and entity-level validation, including cross-entity validation.  We largely built on top of the previous post that explained how ValidationContext can be set up to provide state and services.  And this has all been part of an in-depth series on RIA Services validation.  Here’s the full series:</p>

<ol>
  <ol>
  <li><a href="http://jeffhandley.com/archive/2010/09/22/RiaServicesStandardValidators.aspx">Standard Validators</a></li>

  <li><a href="http://jeffhandley.com/archive/2010/09/25/RiaServicesCustomValidationMethods.aspx">Custom Validation Methods</a></li>

  <li><a href="http://jeffhandley.com/archive/2010/09/26/RiaServicesCustomReusableValidators.aspx">Custom Reusable Validators</a></li>

  <li><a href="http://jeffhandley.com/archive/2010/09/30/RiaServicesValidationAttributePropagation.aspx">Attribute Propagation</a></li>

  <li><a href="http://jeffhandley.com/archive/2010/10/06/RiaServicesValidationTriggers.aspx">Validation Triggers</a></li>

  <li><a href="http://jeffhandley.com/archive/2010/10/10/CrossFieldValidation.aspx">Cross-Field Validation</a></li>

  <li><a href="http://jeffhandley.com/archive/2010/10/12/EntityLevelValidation.aspx">Entity-Level Validation</a></li>

  <li><a href="http://jeffhandley.com/archive/2010/10/25/RiaServicesValidationContext.aspx">Providing ValidationContext</a></li>

  <li><a href="http://jeffhandley.com/archive/2010/10/25/CrossEntityValidation.aspx">Using ValidationContext (Cross-Entity Validation)</a></li>

  <li><a href="http://jeffhandley.com/archive/2011/09/06/ViewModelValidation.aspx">ViewModel Validation with Entity Rules</a></li>
  </ol>
</ol>

<p><strong><em>[9/6/2011] The source code for everything shown during the series is <a href="http://jeffhandley.com/archive/2011/09/06/RIA-Services-Validation-Available-on-GitHub.aspx">available on GitHub</a>.</em></strong></p>

<h3>Digging Deeper</h3>

<p>We still have more to cover; I’ll soon provide a validator factory that allows validation rules from entities to be inherited into a ViewModel.</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:0767317B-992E-4b12-91E0-4F059A8CECA8:3efc8361-d8f8-4733-85ae-ccd0c234c826" class="wlWriterEditableSmartContent">Technorati Tags: <a href="http://technorati.com/tags/RiaServicesValidation" rel="tag">RiaServicesValidation</a>,<a href="http://technorati.com/tags/RiaServices" rel="tag">RiaServices</a>,<a href="http://technorati.com/tags/Validation" rel="tag">Validation</a>,<a href="http://technorati.com/tags/Silverlight" rel="tag">Silverlight</a>,<a href="http://technorati.com/tags/DataAnnotations" rel="tag">DataAnnotations</a></div>

